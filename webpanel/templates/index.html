<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Multi-Service Analytics</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .chart-container {position:relative;height:300px;width:100%;margin-bottom:2rem;}

    /* ---------- LOADER ---------- */
    #loader {
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,.85);
      backdrop-filter: blur(4px);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: system-ui, sans-serif;
    }
    #loader .spinner-border {
      width: 3rem;
      height: 3rem;
      margin-bottom: .75rem;
      color: #0d6efd;
    }
    #loader .text-muted {
      font-size: 1.1rem;

      .chart-container canvas {
        max-height: 280px;
      }
    }
  </style>
</head>
<body>
<nav class="navbar navbar-light bg-light mb-3">
  <div class="container-fluid">
    <span class="navbar-brand mb-0 h1">Analytics Dash</span>
    <select id="serviceSelect" class="form-select w-auto"></select>
    <span id="lastUpdate" class="text-muted small ms-3"></span>
  </div>
</nav>

<div class="container-fluid">
  <!-- KPI -->
  <div class="row mb-3">
    <div class="col-md-3"><div class="card text-center"><div class="card-body">
      <h6>Total hits</h6><h4 id="kpiTotal" class="text-primary">-</h4></div></div></div>
    <div class="col-md-3"><div class="card text-center"><div class="card-body">
      <h6>Unique IPs (24h)</h6><h4 id="kpiUnique" class="text-success">-</h4></div></div></div>
    <div class="col-md-3"><div class="card text-center"><div class="card-body">
      <h6>Mobile share</h6><h4 id="kpiMobile" class="text-info">-</h4></div></div></div>
    <div class="col-md-3"><div class="card text-center"><div class="card-body">
      <h6>Endpoints</h6><h4 id="kpiEndpoints" class="text-danger">-</h4></div></div></div>
  </div>

  <!-- Charts -->
  <div class="row">
      <div class="col-lg-8"><div class="card"><div class="card-header">Hits & Unique IPs (30 days)</div>
      <div class="card-body"><div class="chart-container"><canvas id="hitsChart"></canvas></div></div></div></div>
    <div class="col-lg-4"><div class="card"><div class="card-header">Top Endpoints</div>
      <div class="card-body"><div class="chart-container"><canvas id="endpointsChart"></canvas></div></div></div></div>
  </div>

  <div class="row mt-4">
    <div class="col-lg-6"><div class="card"><div class="card-header">HTTP Methods</div>
      <div class="card-body"><div class="chart-container"><canvas id="methodsChart"></canvas></div></div></div></div>
    <div class="col-lg-6"><div class="card"><div class="card-header">User-Agent Breakdown</div>
      <div class="card-body"><div class="chart-container"><canvas id="uaChart"></canvas></div></div></div></div>

  <!-- Recent rows -->
  <div class="card mt-4"><div class="card-header">Recent Connections</div>
    <div class="card-body"><div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light"><tr>
          <th>Time</th><th>Endpoint</th><th>Method</th><th>IP</th><th>Mobile</th><th>User-Agent</th>
        </tr></thead><tbody id="recentTable"></tbody></table>
    </div></div>
  </div>
</div>

<!-- ---------- LOADER ---------- -->
<div id="loader">
  <div class="spinner-border" role="status"></div>
  <span class="text-muted">Подгружаем данные, ожидайте…</span>
</div>

<script>
const API_URL = 'https://analyze.hikariplus.ru/pub_dash';
let DATA, SEL = document.getElementById('serviceSelect');
let charts = {};

fetch(API_URL)
  .then(r => r.json())
  .then(d => {
    document.getElementById('loader').remove();   // <-- hide loader
    console.log('✅ payload', d);
    DATA = d;
    SEL.innerHTML = Object.keys(d.services)
      .map(s => `<option value="${s}">${s}</option>`)
      .join('');
    SEL.onchange = render;
    SEL.dispatchEvent(new Event('change'));
  })
  .catch(console.error);

function fmtTime(ts) {
  const date = new Date(ts);
  return date.toLocaleDateString([], {
    day: 'numeric',
    month: 'short',
    year: date.getFullYear() !== new Date().getFullYear() ? '2-digit' : undefined
  });
}
function colors() {
  return `hsl(${Math.random() * 360}, 70%, 60%)`;
}

function render() {
  const svc = SEL.value;
  const d   = DATA.services[svc] || {};   // ← ALWAYS use service section

  /* KPI */
  document.getElementById('kpiTotal').textContent     = (d.total_hits || 0).toLocaleString();
  document.getElementById('kpiUnique').textContent = (
    d.unique_ips_24h ||
    (d.unique_addr_series?.slice(-1)[0]?.y || 0)
  ).toLocaleString();
  document.getElementById('kpiMobile').textContent  = ((d.mobile_share_series?.slice(-1)[0]?.y || 0) * 100).toFixed(1) + '%';
  document.getElementById('kpiEndpoints').textContent = (d.top_endpoints || []).length;

  /* Recent rows */
  const tbody = document.getElementById('recentTable');
  tbody.innerHTML = '';
  (d.recent_rows || []).forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${fmtTime(r.timed)}</td>
      <td>${r.name}</td>
      <td><span class="badge bg-secondary">${r.method}</span></td>
      <td><code>${r.addr}</code></td>
      <td>${r.is_mobile === 'true' ? '✅' : '❌'}</td>
      <td class="text-truncate" style="max-width:200px">${r.user_agent}</td>`;
    tbody.appendChild(tr);
  });

  /* Destroy old charts */
  Object.values(charts).forEach(c => c && c.destroy());
  charts = {};

  /* ---------- Charts ---------- */
  const hits   = d.hits_series        || [];
  const unique = d.unique_addr_series || [];
  if (hits.length || unique.length) {
    charts.hits = new Chart(document.getElementById('hitsChart'), {
      type: 'line',
      data: {
        labels: hits.map(p => fmtTime(p.x)),
        datasets: [
          {
            label: 'Hits',
            data: hits.map(p => p.y),
            borderColor: '#0d6efd',
            backgroundColor: 'rgba(13, 110, 253, 0.1)',
            fill: true,
            tension: 0.1,
            pointRadius: 3
          },
          {
            label: 'Unique IPs',
            data: unique.map(p => p.y),
            borderColor: '#198754',
            backgroundColor: 'rgba(25, 135, 84, 0.1)',
            fill: true,
            tension: 0.1,
            pointRadius: 3
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            ticks: {
              maxRotation: 45,
              minRotation: 45
            }
          }
        }
      }
    });
  }

  const ends = d.top_endpoints || [];
  if (ends.length) {
    charts.endpoints = new Chart(document.getElementById('endpointsChart'), {
      type: 'bar',
      data: {
        labels: ends.map(e => e.label),
        datasets: [{ label: 'Hits', data: ends.map(e => e.value), backgroundColor: ends.map(colors) }]
      },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });
  }

  const meths = d.top_methods || [];
  if (meths.length) {
    charts.methods = new Chart(document.getElementById('methodsChart'), {
      type: 'doughnut',
      data: {
        labels: meths.map(m => m.label),
        datasets: [{ data: meths.map(m => m.value), backgroundColor: meths.map(colors) }]
      },
      options: { responsive: true, maintainAspectRatio: false }
    });
  }

  const uas = d.ua_breakdown || [];
  if (uas.length) {
    charts.ua = new Chart(document.getElementById('uaChart'), {
      type: 'doughnut',
      data: {
        labels: uas.map(u => u.label),
        datasets: [{ data: uas.map(u => u.value), backgroundColor: uas.map(colors) }]
      },
      options: { responsive: true, maintainAspectRatio: false }
    });
  }
}
</script>
</body>
</html>
