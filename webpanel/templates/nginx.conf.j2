server {
    if ($host = {{ domain }}) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


        listen 80;
        server_name {{ domain }};

        return 301 https://{{ domain }}$request_uri;


}

server {
    listen 443 ssl;
        server_name {{ domain }};
    ssl_certificate /etc/letsencrypt/live/{{ domain }}/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/{{ domain }}/privkey.pem; # managed by Certbot


    ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
    ssl_ciphers         HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

location / {
              mirror /mirror;  # Дублируем запрос
              mirror_request_body on;  # Если нужно дублировать тело запроса

              proxy_redirect          http://0.0.0.0:8000 /;
              proxy_pass_header       Server;
              proxy_set_header        X-Real-IP $remote_addr;
              proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header        X-Scheme $scheme;
              proxy_set_header        Host $http_host;
              proxy_set_header        X-NginX-Proxy true;
              proxy_connect_timeout   5;
              proxy_read_timeout      240;
              proxy_intercept_errors  on;

              proxy_pass              http://0.0.0.0:8000;
}
location /mirror {
    internal;
    access_log /var/log/nginx/mirror.log;
    error_log /var/log/nginx/mirror_error.log;
    proxy_pass https://analyze.hikariplus.ru/{{ service }}$request_uri;
    proxy_set_header X-Original-Path $request_uri;
    proxy_ssl_verify off;
    proxy_set_header Host analyze.hikariplus.ru;
    
    # Передаем оригинальные IP-заголовки
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header User-Agent $http_user_agent;
    # Копируем все заголовки из оригинального запроса
    proxy_pass_request_headers on;
}
    location = /favicon.ico { access_log off; log_not_found off; }
    location /static/ {
        autoindex on;
			#путь до static каталога
    }

    location /media/ {
       #путь до media каталога
    }

}
